<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GitHub App - REST API Explorer</title>
    <link rel="stylesheet" href="styles.css"/>
</head>
<body>
    <h1 class="main-title">GitHub REST API Explorer</h1>
    <div class="auth-container">
        <button id="loginBtn">🔐 Login with GitHub</button>
        <button id="logoutBtn" style="display:none;">🚪 Logout</button>
        <p id="userInfo"></p>
    </div>

    <!-- Navigation -->
    <div class="nav-container">
        <div class="nav-tabs">
            <div class="nav-tab active" data-section="get">📥 GET - Retrieve Resources</div>
            <div class="nav-tab" data-section="post">📤 POST - Create Resources</div>
            <div class="nav-tab" data-section="patch">🔧 PATCH - Update Resources</div>
            <div class="nav-tab" data-section="put">🔄 PUT - Replace Resources</div>
            <div class="nav-tab" data-section="delete">🗑️ DELETE - Remove Resources</div>
            <script>
        // Navigation functionality
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and sections
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Show corresponding section
                const sectionId = tab.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
            });
        });
    </script>
        </div>
    </div>

    <!-- GET Section -->
    <div class="section active" id="get">
        <h2>Get Repositories</h2>
        <button id="fetchRepos">Fetch Repositories</button>
        <ul id="repoList"></ul>
    </div>

    <!-- POST Section -->
    <div class="section" id="post">
        <h2>Create Issue</h2>
        <input type="text" id="repoName" placeholder="Repository (owner/repo)" />
        <input type="text" id="issueTitle" placeholder="Issue Title" />
        <textarea id="issueBody" placeholder="Issue Description"></textarea>
        <button id="createIssue">Create Issue</button>
        <p id="issueResult"></p>
    </div>

    <!-- PATCH Section -->
    <div class="section patch" id="patch">
        <h2>Update Resources</h2>
        <div class="empty-section">
            <div class="icon">🔧</div>
            <h3>PATCH Operations</h3>
            <p>This section will contain functionality to update existing GitHub resources like repositories, issues, pull requests, and user profiles using PATCH requests.</p>
            <span class="coming-soon">Coming Soon</span>
        </div>
    </div>

    <!-- PUT Section -->
    <div class="section put" id="put">
        <h2>Replace Resources</h2>
        <div class="empty-section">
            <div class="icon">🔄</div>
            <h3>PUT Operations</h3>
            <p>This section will contain functionality to replace or create GitHub resources like repository settings, collaborators, and subscription management using PUT requests.</p>
            <span class="coming-soon">Coming Soon</span>
        </div>
    </div>

    <!-- DELETE Section -->
    <div class="section delete" id="delete">
        <h2>Delete Resources</h2>
        <div class="empty-section">
            <div class="icon">🗑️</div>
            <h3>DELETE Operations</h3>
            <p>This section will contain functionality to delete GitHub resources like repositories, issues, comments, and remove collaborators using DELETE requests.</p>
            <span class="coming-soon">Coming Soon</span>
        </div>
    </div>

    <script>
        document.getElementById('loginBtn').addEventListener('click', () => {
            window.location.href = 'https://github.com/login/oauth/authorize?client_id=Ov23liUSn6KNi2EZZGLh&scope=repo';
        });

        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        let token = urlParams.get('token');

        // If token is in URL, store it
        if (token) {
            localStorage.setItem('githubToken', token);

            // Clean the URL
            if (window.history.replaceState) {
                window.history.replaceState({}, document.title, '/');
            }
        } else {
            // If token is not in URL, try to load from localStorage
            token = localStorage.getItem('githubToken');
        }

        async function loadUserInfo() {
            if (!token) return;

            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `token ${token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch user info.');

                const user = await response.json();
                document.getElementById('userInfo').textContent = `Logged in as ${user.login}`;
                document.getElementById('logoutBtn').style.display = 'inline-block';
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
        }

        loadUserInfo();

        document.getElementById('fetchRepos').addEventListener('click', async () => {
            try {
                const token = localStorage.getItem('githubToken'); 

                const response = await fetch('https://github-app-backend.vercel.app/api/list-repos', {
                    headers: { Authorization: `token ${token}` } 
                });
        
                if (!response.ok) throw new Error('Failed to fetch repositories.');

                const data = await response.json();
                const repos = data.repositories;

                const repoList = document.getElementById('repoList');
                repoList.innerHTML = '';

                repos.forEach(repo => {
                    const listItem = document.createElement('li');
                    listItem.textContent = repo.full_name;
                    repoList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error fetching repositories:', error);
            }
        });

        document.getElementById('createIssue').addEventListener('click', async () => {
            const repo = document.getElementById('repoName').value;
            const title = document.getElementById('issueTitle').value;
            const body = document.getElementById('issueBody').value;

            try {
                const token = localStorage.getItem('githubToken'); // Get the token

                const response = await fetch('https://github-app-backend.vercel.app/api/create-issue', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        Authorization: `token ${token}` // ✅ Send token here
                    },
                    body: JSON.stringify({ repo, title, body })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('issueResult').innerText = `Issue Created: ${data.html_url}`;
                } else {
                    document.getElementById('issueResult').innerText = 'Error creating issue.';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('issueResult').innerText = 'Error creating issue.';
            }
        });


        if (token) {
            document.getElementById('loginBtn').style.display = 'none';
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('githubToken');
            window.location.reload();
        });

        if (token) {
            document.getElementById('logoutBtn').style.display = 'inline-block';
        }

    </script>
</body>
</html>