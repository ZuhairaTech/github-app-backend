<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GitHub App - REST API Explorer</title>
    <link rel="stylesheet" href="styles.css"/>
</head>

<body>
    <section class="layout">
        <div class="header">
            <!-- Navigation -->
            <h1 class="main-title">GitHub REST API Explorer</h1>

            <div class="nav-container">
                <div class="nav-tabs">
                    <div class="nav-tab active" data-section="get">üì• GET - Retrieve Resources</div>
                    <div class="nav-tab" data-section="post">üì§ POST - Create Resources</div>
                    <div class="nav-tab" data-section="patch">üîß PATCH - Update Resources</div>
                    <div class="nav-tab" data-section="put">üîÑ PUT - Replace Resources</div>
                    <div class="nav-tab" data-section="delete">üóëÔ∏è DELETE - Remove Resources</div>
                    <script>
                // Navigation functionality
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active class from all tabs and sections
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                        
                        // Add active class to clicked tab
                        tab.classList.add('active');
                        
                        // Show corresponding section
                        const sectionId = tab.getAttribute('data-section');
                        document.getElementById(sectionId).classList.add('active');
                    });
                });
            </script>
                </div>
            </div>
        </div>

        <div class="leftSide">
            <div class="auth-container">
                <p id="userInfo"></p>
                <button id="loginBtn">üîê Login </button>
                <button id="logoutBtn" style="display:none;">üö™ Logout</button>
            </div>
        </div>

        <div class="body">
            <!-- GET Section -->
            <div class="section active" id="get">
                <h2>Get Repositories</h2>
                <button id="fetchRepos">Fetch Repositories</button>
                <ul id="repoList"></ul>
            </div>

            <!-- POST Section -->
            <div class="section" id="post">
                <h2>Create Issue</h2>
                <input type="text" id="repoName" placeholder="Repository (owner/repo)" />
                <input type="text" id="issueTitle" placeholder="Issue Title" />
                <textarea id="issueBody" placeholder="Issue Description"></textarea>
                <button id="createIssue">Create Issue</button>
                <p id="issueResult"></p>
            </div>

            <!-- PATCH Section -->
            <div class="section patch" id="patch">
                <h2>Update Issue</h2>
                <input type="text" id="patchRepo" placeholder="Repository (owner/repo)" />
                <input type="text" id="patchIssueNumber" placeholder="Issue Number" />
                <input type="text" id="patchTitle" placeholder="New Issue Title" />
                <textarea id="patchBody" placeholder="New Issue Description"></textarea>
                <button id="patchIssue">Update Issue</button>
                <p id="patchResult"></p>
            </div>

            <!-- PUT Section -->
            <div class="section put" id="put">
                <h2>Star Repository</h2>
                <input type="text" id="starRepo" placeholder="Repository (owner/repo)" />
                <button id="starBtn">Star Repository</button>
                <p id="starResult"></p>
            </div>

            <!-- DELETE Section -->
            <div class="section delete" id="delete">
                <h2>Unstar Repository</h2>
                <input type="text" id="unstarRepo" placeholder="Repository (owner/repo)" />
                <button id="unstarBtn">Unstar Repository</button>
                <p id="unstarResult"></p>
            </div>

            <script>
                document.getElementById('loginBtn').addEventListener('click', () => {
                    window.location.href = 'https://github.com/login/oauth/authorize?client_id=Ov23liUSn6KNi2EZZGLh&scope=repo';
                });

                // Get token from URL
                const urlParams = new URLSearchParams(window.location.search);
                let token = urlParams.get('token');

                // If token is in URL, store it
                if (token) {
                    localStorage.setItem('githubToken', token);

                    // Clean the URL
                    if (window.history.replaceState) {
                        window.history.replaceState({}, document.title, '/');
                    }
                } else {
                    // If token is not in URL, try to load from localStorage
                    token = localStorage.getItem('githubToken');
                }

                async function loadUserInfo() {
                    if (!token) return;

                    try {
                        const response = await fetch('https://api.github.com/user', {
                            headers: { Authorization: `token ${token}` }
                        });

                        if (!response.ok) throw new Error('Failed to fetch user info.');

                        const user = await response.json();
                        document.getElementById('userInfo').innerHTML = `
                            <img src="${user.avatar_url}" alt="Avatar" width="50" style="border-radius: 50%;">
                            <p><a href="${user.html_url}" target="_blank">${user.login}</a></p>
                            <p>Name: ${user.name || 'Not provided'}</p>
                            <p>üìç ${user.location || 'Not provided'}</p>
                            <p>Public Repos: ${user.public_repos}</p>
                            <p>Followers: ${user.followers}</p>
                            <p>Following: ${user.following}</p>
                        `;

                        document.getElementById('logoutBtn').style.display = 'inline-block';
                    } catch (error) {
                        console.error('Error fetching user info:', error);
                    }
                }

                loadUserInfo();

                document.getElementById('fetchRepos').addEventListener('click', async () => {
                    try {
                        const token = localStorage.getItem('githubToken'); 

                        const response = await fetch('https://github-app-backend.vercel.app/api/list-repos', {
                            headers: { Authorization: `token ${token}` } 
                        });
                
                        if (!response.ok) throw new Error('Failed to fetch repositories.');

                        const data = await response.json();
                        const repos = data.repositories;

                        const repoList = document.getElementById('repoList');
                        repoList.innerHTML = '';

                        repos.forEach(repo => {
                            const listItem = document.createElement('li');
                            listItem.textContent = repo.full_name;
                            repoList.appendChild(listItem);
                        });
                    } catch (error) {
                        console.error('Error fetching repositories:', error);
                    }
                });

                document.getElementById('createIssue').addEventListener('click', async () => {
                    const repo = document.getElementById('repoName').value;
                    const title = document.getElementById('issueTitle').value;
                    const body = document.getElementById('issueBody').value;

                    try {
                        const token = localStorage.getItem('githubToken'); // Get the token

                        const response = await fetch('https://github-app-backend.vercel.app/api/create-issue', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                Authorization: `token ${token}` // ‚úÖ Send token here
                            },
                            body: JSON.stringify({ repo, title, body })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            document.getElementById('issueResult').innerText = `Issue Created: ${data.html_url}`;
                        } else {
                            document.getElementById('issueResult').innerText = 'Error creating issue.';
                        }
                    } catch (error) {
                        console.error(error);
                        document.getElementById('issueResult').innerText = 'Error creating issue.';
                    }
                });

                document.getElementById('patchIssue').addEventListener('click', async () => {
                    const repo = document.getElementById('patchRepo').value;
                    const issueNumber = document.getElementById('patchIssueNumber').value;
                    const title = document.getElementById('patchTitle').value;
                    const body = document.getElementById('patchBody').value;

                    try {
                        const token = localStorage.getItem('githubToken');

                        const response = await fetch(`https://api.github.com/repos/${repo}/issues/${issueNumber}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                Authorization: `token ${token}`
                            },
                            body: JSON.stringify({ title, body })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            document.getElementById('patchResult').innerText = `Issue Updated: ${data.html_url}`;
                        } else {
                            document.getElementById('patchResult').innerText = 'Error updating issue.';
                        }
                    } catch (error) {
                        console.error(error);
                        document.getElementById('patchResult').innerText = 'Error updating issue.';
                    }
                });

                document.getElementById('starBtn').addEventListener('click', async () => {
                    const repo = document.getElementById('starRepo').value;
                    const token = localStorage.getItem('githubToken');

                    try {
                        const response = await fetch(`https://api.github.com/user/starred/${repo}`, {
                            method: 'PUT',
                            headers: {
                                Authorization: `token ${token}`
                            }
                        });

                        if (response.status === 204) {
                            document.getElementById('starResult').innerText = 'Repository starred successfully!';
                        } else {
                            document.getElementById('starResult').innerText = 'Failed to star repository.';
                        }
                    } catch (error) {
                        console.error(error);
                        document.getElementById('starResult').innerText = 'Error starring repository.';
                    }
                });

                document.getElementById('unstarBtn').addEventListener('click', async () => {
                    const repo = document.getElementById('unstarRepo').value;
                    const token = localStorage.getItem('githubToken');

                    try {
                        const response = await fetch(`https://api.github.com/user/starred/${repo}`, {
                            method: 'DELETE',
                            headers: {
                                Authorization: `token ${token}`
                            }
                        });

                        if (response.status === 204) {
                            document.getElementById('unstarResult').innerText = 'Repository unstarred successfully!';
                        } else {
                            document.getElementById('unstarResult').innerText = 'Failed to unstar repository.';
                        }
                    } catch (error) {
                        console.error(error);
                        document.getElementById('unstarResult').innerText = 'Error unstarring repository.';
                    }
                });




                if (token) {
                    document.getElementById('loginBtn').style.display = 'none';
                }

                document.getElementById('logoutBtn').addEventListener('click', () => {
                    localStorage.removeItem('githubToken');
                    window.location.reload();
                });

                if (token) {
                    document.getElementById('logoutBtn').style.display = 'inline-block';
                }

            </script>
        </div>

        <div class="footer">4</div>
    </section>
</body>
</html>