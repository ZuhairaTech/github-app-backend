<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GitHub App - REST API Explorer</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="decorative-element"></div>
            <h1 class="main-title">üöÄ GitHub REST API Explorer</h1>
        </div>

        <div class="auth-section">
            <div id="userInfo"></div>
            <button id="loginBtn" class="btn">üîê Connect to GitHub</button>
            <button id="logoutBtn" class="btn btn-secondary" style="display:none;">üö™ Disconnect</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-section="get">üì• GET - Retrieve</button>
            <button class="nav-tab" data-section="post">üì§ POST - Create</button>
            <button class="nav-tab" data-section="patch">üîß PATCH - Update</button>
            <button class="nav-tab" data-section="put">‚≠ê PUT - Star</button>
            <button class="nav-tab" data-section="delete">üóëÔ∏è DELETE - Remove</button>
        </div>

        <!-- GET Section -->
        <div class="section active" id="get">
            <h2>üì• Retrieve Repositories</h2>
            <div class="form-group">
                <button id="fetchRepos" class="btn">üîç Fetch My Repositories</button>
            </div>
            <div id="repoListContainer">
                <ul id="repoList" class="repo-list"></ul>
            </div>
        </div>

        <!-- POST Section -->
        <div class="section" id="post">
            <h2>üì§ Create New Issue</h2>
            <div class="form-group">
                <label for="repoName">Repository (owner/repo)</label>
                <input type="text" id="repoName" placeholder="e.g., octocat/Hello-World" />
            </div>
            <div class="form-group">
                <label for="issueTitle">Issue Title</label>
                <input type="text" id="issueTitle" placeholder="Brief description of the issue" />
            </div>
            <div class="form-group">
                <label for="issueBody">Issue Description</label>
                <textarea id="issueBody" placeholder="Detailed description of the issue..."></textarea>
            </div>
            <button id="createIssue" class="btn">‚ú® Create Issue</button>
            <div id="issueResult" class="result" style="display:none;"></div>
        </div>

        <!-- PATCH Section -->
        <div class="section" id="patch">
            <h2>üîß Update Existing Issue</h2>
            <div class="two-column">
                <div class="form-group">
                    <label for="patchRepo">Repository (owner/repo)</label>
                    <input type="text" id="patchRepo" placeholder="e.g., octocat/Hello-World" />
                </div>
                <div class="form-group">
                    <label for="patchIssueNumber">Issue Number</label>
                    <input type="text" id="patchIssueNumber" placeholder="e.g., 123" />
                </div>
            </div>
            <div class="form-group">
                <label for="patchTitle">New Issue Title</label>
                <input type="text" id="patchTitle" placeholder="Updated issue title" />
            </div>
            <div class="form-group">
                <label for="patchBody">New Issue Description</label>
                <textarea id="patchBody" placeholder="Updated issue description..."></textarea>
            </div>
            <button id="patchIssue" class="btn">üîÑ Update Issue</button>
            <div id="patchResult" class="result" style="display:none;"></div>
        </div>

        <!-- PUT Section -->
        <div class="section" id="put">
            <h2>‚≠ê Star Repository</h2>
            <div class="form-group">
                <label for="starRepo">Repository (owner/repo)</label>
                <input type="text" id="starRepo" placeholder="e.g., octocat/Hello-World" />
            </div>
            <button id="starBtn" class="btn">‚≠ê Star Repository</button>
            <div id="starResult" class="result" style="display:none;"></div>
        </div>

        <!-- DELETE Section -->
        <div class="section" id="delete">
            <h2>üóëÔ∏è Unstar Repository</h2>
            <div class="form-group">
                <label for="unstarRepo">Repository (owner/repo)</label>
                <input type="text" id="unstarRepo" placeholder="e.g., octocat/Hello-World" />
            </div>
            <button id="unstarBtn" class="btn">üíî Unstar Repository</button>
            <div id="unstarResult" class="result" style="display:none;"></div>
        </div>

        <div class="footer">
            <p>Built with ‚ù§Ô∏è using GitHub REST API</p>
        </div>
    </div>

    <script>
        // Navigation functionality
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                tab.classList.add('active');
                const sectionId = tab.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
            });
        });

        // Auth functionality
        document.getElementById('loginBtn').addEventListener('click', () => {
            window.location.href = 'https://github.com/login/oauth/authorize?client_id=Ov23liUSn6KNi2EZZGLh&scope=repo';
        });

        // Token management
        const urlParams = new URLSearchParams(window.location.search);
        let token = urlParams.get('token');

        if (token) {
            // Store token in memory instead of localStorage
            window.githubToken = token;
            if (window.history.replaceState) {
                window.history.replaceState({}, document.title, '/');
            }
        }

        // Helper functions
        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = isError ? 'result error' : 'result';
            element.style.display = 'block';
        }

        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '<div class="loading">Loading repositories</div>';
        }

        async function loadUserInfo() {
            const currentToken = window.githubToken;
            if (!currentToken) return;

            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `token ${currentToken}` }
                });

                if (!response.ok) throw new Error('Failed to fetch user info.');

                const user = await response.json();
                document.getElementById('userInfo').innerHTML = `
                    <div class="user-info">
                        <img src="${user.avatar_url}" alt="Avatar" class="user-avatar">
                        <div class="user-details">
                            <h3><a href="${user.html_url}" target="_blank">${user.login}</a></h3>
                            <p><strong>Name:</strong> ${user.name || 'Not provided'}</p>
                            <p><strong>Location:</strong> ${user.location || 'Not provided'}</p>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number">${user.public_repos}</div>
                                    <div class="stat-label">Repositories</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${user.followers}</div>
                                    <div class="stat-label">Followers</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${user.following}</div>
                                    <div class="stat-label">Following</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline-block';
            } catch (error) {
                console.error('Error fetching user info:', error);
                showResult('userInfo', 'Error loading user information', true);
            }
        }

        loadUserInfo();

        // Fetch repositories
        document.getElementById('fetchRepos').addEventListener('click', async () => {
            showLoading('repoListContainer');
            
            try {
                const currentToken = window.githubToken;
                const response = await fetch('https://github-app-backend.vercel.app/api/list-repos', {
                    headers: { Authorization: `token ${currentToken}` }
                });

                if (!response.ok) throw new Error('Failed to fetch repositories.');

                const data = await response.json();
                const repos = data.repositories;
                const repoList = document.getElementById('repoList');
                
                repoList.innerHTML = '';
                
                if (repos.length === 0) {
                    repoList.innerHTML = '<li class="repo-item">No repositories found</li>';
                    return;
                }

                repos.forEach(repo => {
                    const listItem = document.createElement('li');
                    listItem.className = 'repo-item';
                    listItem.innerHTML = `
                        <div class="repo-name">${repo.full_name}</div>
                        <div class="repo-description">${repo.description || 'No description available'}</div>
                    `;
                    repoList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error fetching repositories:', error);
                document.getElementById('repoListContainer').innerHTML = 
                    '<div class="result error">Error fetching repositories. Please try again.</div>';
            }
        });

        // Create issue
        document.getElementById('createIssue').addEventListener('click', async () => {
            const repo = document.getElementById('repoName').value;
            const title = document.getElementById('issueTitle').value;
            const body = document.getElementById('issueBody').value;

            if (!repo || !title) {
                showResult('issueResult', 'Please fill in repository and title fields', true);
                return;
            }

            try {
                const currentToken = window.githubToken;
                const response = await fetch('https://github-app-backend.vercel.app/api/create-issue', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        Authorization: `token ${currentToken}`
                    },
                    body: JSON.stringify({ repo, title, body })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('issueResult', `‚úÖ Issue created successfully! View at: ${data.html_url}`);
                    // Clear form
                    document.getElementById('repoName').value = '';
                    document.getElementById('issueTitle').value = '';
                    document.getElementById('issueBody').value = '';
                } else {
                    showResult('issueResult', '‚ùå Error creating issue. Check repository name and permissions.', true);
                }
            } catch (error) {
                console.error(error);
                showResult('issueResult', '‚ùå Network error. Please try again.', true);
            }
        });

        // Update issue
        document.getElementById('patchIssue').addEventListener('click', async () => {
            const repo = document.getElementById('patchRepo').value;
            const issueNumber = document.getElementById('patchIssueNumber').value;
            const title = document.getElementById('patchTitle').value;
            const body = document.getElementById('patchBody').value;

            if (!repo || !issueNumber) {
                showResult('patchResult', 'Please fill in repository and issue number fields', true);
                return;
            }

            try {
                const currentToken = window.githubToken;
                const response = await fetch(`https://api.github.com/repos/${repo}/issues/${issueNumber}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `token ${currentToken}`
                    },
                    body: JSON.stringify({ title, body })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('patchResult', `‚úÖ Issue updated successfully! View at: ${data.html_url}`);
                } else {
                    showResult('patchResult', '‚ùå Error updating issue. Check repository name, issue number, and permissions.', true);
                }
            } catch (error) {
                console.error(error);
                showResult('patchResult', '‚ùå Network error. Please try again.', true);
            }
        });

        // Star repository
        document.getElementById('starBtn').addEventListener('click', async () => {
            const repo = document.getElementById('starRepo').value;
            
            if (!repo) {
                showResult('starResult', 'Please enter a repository name', true);
                return;
            }

            try {
                const currentToken = window.githubToken;
                const response = await fetch(`https://api.github.com/user/starred/${repo}`, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${currentToken}`
                    }
                });

                if (response.status === 204) {
                    showResult('starResult', `‚≠ê Repository ${repo} starred successfully!`);
                    document.getElementById('starRepo').value = '';
                } else {
                    showResult('starResult', '‚ùå Failed to star repository. Check repository name.', true);
                }
            } catch (error) {
                console.error(error);
                showResult('starResult', '‚ùå Network error. Please try again.', true);
            }
        });

        // Unstar repository
        document.getElementById('unstarBtn').addEventListener('click', async () => {
            const repo = document.getElementById('unstarRepo').value;
            
            if (!repo) {
                showResult('unstarResult', 'Please enter a repository name', true);
                return;
            }

            try {
                const currentToken = window.githubToken;
                const response = await fetch(`https://api.github.com/user/starred/${repo}`, {
                    method: 'DELETE',
                    headers: {
                        Authorization: `token ${currentToken}`
                    }
                });

                if (response.status === 204) {
                    showResult('unstarResult', `üíî Repository ${repo} unstarred successfully!`);
                    document.getElementById('unstarRepo').value = '';
                } else {
                    showResult('unstarResult', '‚ùå Failed to unstar repository. Check repository name.', true);
                }
            } catch (error) {
                console.error(error);
                showResult('unstarResult', '‚ùå Network error. Please try again.', true);
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            window.githubToken = null;
            window.location.reload();
        });
    </script>
</body>
</html>